/**
 * @file bench_hermite_e_symbolic.cpp
 * @brief Benchmarks for symbolically-generated Hermite E coefficients
 *
 * Tests the CSE-optimized unrolled expressions generated by SymPy.
 * These represent highly optimized symbolic solutions to the recurrence.
 */

#include <benchmark/benchmark.h>
#include "hermite_e_symbolic.hpp"
#include "benchmark_common.hpp"

using namespace recursum::symbolic;
using namespace recursum::benchmark;

// =============================================================================
// Individual Coefficient Benchmarks (Symbolic Implementation)
// =============================================================================

#define BENCH_HERMITE_E_SYMBOLIC(NA, NB, T) \
static void BM_HermiteE_Symbolic_##NA##_##NB##_##T(benchmark::State& state) { \
    GeometryParams params(42); \
    Vec8d result; \
    int64_t total_geometries = 0; \
    for (auto _ : state) { \
        result = hermite_e_symbolic_##NA##_##NB##_##T( \
            params.PA[0], params.PB[0], params.one_over_2p); \
        benchmark::DoNotOptimize(result); \
        total_geometries += 8; \
    } \
    state.counters["Geometries/s"] = benchmark::Counter( \
        total_geometries, benchmark::Counter::kIsRate); \
    state.counters["nA"] = NA; \
    state.counters["nB"] = NB; \
    state.counters["t"] = T; \
    state.counters["impl"] = 1; \
} \
BENCHMARK(BM_HermiteE_Symbolic_##NA##_##NB##_##T)->Unit(benchmark::kNanosecond)->MinTime(1.0)

// =============================================================================
// Base Cases (s-type)
// =============================================================================
BENCH_HERMITE_E_SYMBOLIC(0, 0, 0);

// =============================================================================
// p-type coefficients (L=1)
// =============================================================================
BENCH_HERMITE_E_SYMBOLIC(1, 0, 0);
BENCH_HERMITE_E_SYMBOLIC(1, 0, 1);
BENCH_HERMITE_E_SYMBOLIC(0, 1, 0);
BENCH_HERMITE_E_SYMBOLIC(0, 1, 1);
BENCH_HERMITE_E_SYMBOLIC(1, 1, 0);
BENCH_HERMITE_E_SYMBOLIC(1, 1, 1);
BENCH_HERMITE_E_SYMBOLIC(1, 1, 2);

// =============================================================================
// d-type coefficients (L=2)
// =============================================================================
BENCH_HERMITE_E_SYMBOLIC(2, 0, 0);
BENCH_HERMITE_E_SYMBOLIC(2, 0, 1);
BENCH_HERMITE_E_SYMBOLIC(2, 0, 2);
BENCH_HERMITE_E_SYMBOLIC(0, 2, 0);
BENCH_HERMITE_E_SYMBOLIC(0, 2, 1);
BENCH_HERMITE_E_SYMBOLIC(0, 2, 2);
BENCH_HERMITE_E_SYMBOLIC(2, 2, 0);
BENCH_HERMITE_E_SYMBOLIC(2, 2, 2);
BENCH_HERMITE_E_SYMBOLIC(2, 2, 4);

// =============================================================================
// f-type coefficients (L=3)
// =============================================================================
BENCH_HERMITE_E_SYMBOLIC(3, 0, 0);
BENCH_HERMITE_E_SYMBOLIC(3, 0, 1);
BENCH_HERMITE_E_SYMBOLIC(3, 0, 2);
BENCH_HERMITE_E_SYMBOLIC(3, 0, 3);
BENCH_HERMITE_E_SYMBOLIC(0, 3, 0);
BENCH_HERMITE_E_SYMBOLIC(0, 3, 3);
BENCH_HERMITE_E_SYMBOLIC(3, 3, 0);
BENCH_HERMITE_E_SYMBOLIC(3, 3, 3);
BENCH_HERMITE_E_SYMBOLIC(3, 3, 6);

// =============================================================================
// Shell Pair Benchmarks
// =============================================================================

static void BM_HermiteE_Symbolic_ShellPair_ss(benchmark::State& state) {
    GeometryParams params(42);
    int64_t total_geometries = 0;

    for (auto _ : state) {
        auto e_000 = hermite_e_symbolic_0_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        benchmark::DoNotOptimize(e_000);
        total_geometries += 8;
    }

    state.counters["Geometries/s"] = benchmark::Counter(total_geometries, benchmark::Counter::kIsRate);
    state.counters["LA"] = 0;
    state.counters["LB"] = 0;
}
BENCHMARK(BM_HermiteE_Symbolic_ShellPair_ss)->Unit(benchmark::kNanosecond)->MinTime(1.0);

static void BM_HermiteE_Symbolic_ShellPair_pp(benchmark::State& state) {
    GeometryParams params(42);
    int64_t total_geometries = 0;

    for (auto _ : state) {
        auto e_000 = hermite_e_symbolic_0_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_100 = hermite_e_symbolic_1_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_101 = hermite_e_symbolic_1_0_1(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_010 = hermite_e_symbolic_0_1_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_011 = hermite_e_symbolic_0_1_1(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_110 = hermite_e_symbolic_1_1_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_111 = hermite_e_symbolic_1_1_1(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_112 = hermite_e_symbolic_1_1_2(params.PA[0], params.PB[0], params.one_over_2p);

        benchmark::DoNotOptimize(e_000);
        benchmark::DoNotOptimize(e_100);
        benchmark::DoNotOptimize(e_112);
        total_geometries += 8;
    }

    state.counters["Geometries/s"] = benchmark::Counter(total_geometries, benchmark::Counter::kIsRate);
    state.counters["LA"] = 1;
    state.counters["LB"] = 1;
}
BENCHMARK(BM_HermiteE_Symbolic_ShellPair_pp)->Unit(benchmark::kNanosecond)->MinTime(1.0);

static void BM_HermiteE_Symbolic_ShellPair_dd(benchmark::State& state) {
    GeometryParams params(42);
    int64_t total_geometries = 0;

    for (auto _ : state) {
        // Compute all dd coefficients using symbolic functions
        auto e_000 = hermite_e_symbolic_0_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_100 = hermite_e_symbolic_1_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_200 = hermite_e_symbolic_2_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_010 = hermite_e_symbolic_0_1_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_020 = hermite_e_symbolic_0_2_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_110 = hermite_e_symbolic_1_1_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_220 = hermite_e_symbolic_2_2_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_224 = hermite_e_symbolic_2_2_4(params.PA[0], params.PB[0], params.one_over_2p);

        benchmark::DoNotOptimize(e_000);
        benchmark::DoNotOptimize(e_220);
        benchmark::DoNotOptimize(e_224);
        total_geometries += 8;
    }

    state.counters["Geometries/s"] = benchmark::Counter(total_geometries, benchmark::Counter::kIsRate);
    state.counters["LA"] = 2;
    state.counters["LB"] = 2;
}
BENCHMARK(BM_HermiteE_Symbolic_ShellPair_dd)->Unit(benchmark::kNanosecond)->MinTime(1.0);

static void BM_HermiteE_Symbolic_ShellPair_ff(benchmark::State& state) {
    GeometryParams params(42);
    int64_t total_geometries = 0;

    for (auto _ : state) {
        // Selected ff coefficients
        auto e_000 = hermite_e_symbolic_0_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_300 = hermite_e_symbolic_3_0_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_030 = hermite_e_symbolic_0_3_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_330 = hermite_e_symbolic_3_3_0(params.PA[0], params.PB[0], params.one_over_2p);
        auto e_336 = hermite_e_symbolic_3_3_6(params.PA[0], params.PB[0], params.one_over_2p);

        benchmark::DoNotOptimize(e_000);
        benchmark::DoNotOptimize(e_330);
        benchmark::DoNotOptimize(e_336);
        total_geometries += 8;
    }

    state.counters["Geometries/s"] = benchmark::Counter(total_geometries, benchmark::Counter::kIsRate);
    state.counters["LA"] = 3;
    state.counters["LB"] = 3;
}
BENCHMARK(BM_HermiteE_Symbolic_ShellPair_ff)->Unit(benchmark::kNanosecond)->MinTime(1.0);

// =============================================================================
// Memory Bandwidth Benchmarks
// =============================================================================

static void BM_HermiteE_Symbolic_Memory(benchmark::State& state) {
    const int num_batches = state.range(0);
    std::vector<GeometryParams> params(num_batches);
    std::vector<Vec8d> results(num_batches);

    for (int i = 0; i < num_batches; ++i) {
        params[i] = GeometryParams(42 + i);
    }

    for (auto _ : state) {
        for (int i = 0; i < num_batches; ++i) {
            results[i] = hermite_e_symbolic_3_3_6(
                params[i].PA[0], params[i].PB[0], params[i].one_over_2p);
        }
        benchmark::DoNotOptimize(results.data());
        benchmark::ClobberMemory();
    }

    int64_t bytes_per_batch = 4 * sizeof(Vec8d);
    state.SetBytesProcessed(state.iterations() * num_batches * bytes_per_batch);
    state.counters["Batches"] = num_batches;
}
BENCHMARK(BM_HermiteE_Symbolic_Memory)->RangeMultiplier(2)->Range(1, 1024)->Unit(benchmark::kMicrosecond);
